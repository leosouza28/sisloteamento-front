<div class="livemap-container">
  <!-- Error State -->
  <div *ngIf="hasError" class="error-overlay">
    <div class="error-content">
      <i class="bi bi-exclamation-triangle-fill text-warning" style="font-size: 3rem;"></i>
      <h3 class="mt-3 text-white">Erro ao carregar mapa</h3>
      <p class="text-white-50">{{ errorMessage }}</p>
      <button class="btn btn-primary mt-3" (click)="loadMap()">
        <i class="bi bi-arrow-clockwise"></i> Tentar novamente
      </button>
    </div>
  </div>

  <!-- Header -->
  <div class="livemap-header">
    <div class="header-content">
      <div>
        <h1 class="h4 mb-1 text-white" *ngIf="loteamentoInfo?.loteamento">
          <i class="bi bi-map"></i> {{ loteamentoInfo.loteamento.nome }}
        </h1>
        <small class="text-white-50" *ngIf="loteamentoInfo?.loteamento">
          {{ loteamentoInfo.loteamento.cidade }} - {{ loteamentoInfo.loteamento.estado }}
        </small>
        <div *ngIf="lastUpdate" class="last-update-badge">
          <i class="bi bi-clock-history"></i> Última atualização: {{ lastUpdate | date:'dd/MM/yyyy HH:mm' }}
        </div>
      </div>
      <button class="btn btn-light btn-sm" (click)="toggleInfo()" *ngIf="loteamentoInfo">
        <i class="bi bi-info-circle"></i> Informações
      </button>
    </div>
  </div>

  <!-- Map Container -->
  <div class="map-wrapper" #mapContainer *ngIf="!hasError">
    <!-- Loading na imagem -->
    <div *ngIf="loading || !imageUrl" class="image-loading">
      <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Carregando imagem...</span>
      </div>
      <p class="mt-3 text-white">Carregando mapa...</p>
    </div>
    
    <div 
      *ngIf="imageUrl"
      class="map-content"
      [class.hidden]="loading"
      (mousedown)="onMouseDown($event)"
      (mousemove)="onMouseMove($event)"
      (mouseup)="onMouseUp()"
      (mouseleave)="onMouseLeave()"
      (touchstart)="onTouchStart($event)"
      (touchmove)="onTouchMove($event)"
      (touchend)="onTouchEnd()"
      (wheel)="onWheel($event)"
      [style.cursor]="getCursor()">
      <img 
        #mapImage
        [src]="imageUrl" 
        [style.transform]="getTransform()"
        [class.no-transition]="!isTransitioning"
        (load)="onImageLoad()"
        (error)="onImageError()"
        alt="Mapa do Loteamento"
        class="map-image">
    </div>
  </div>

  <!-- Zoom Controls -->
  <div class="zoom-controls">
    <button class="btn btn-light btn-sm mb-2" (click)="zoomIn()" [disabled]="scale >= maxScale" title="Aumentar Zoom">
      <i class="bi bi-plus-lg"></i>
    </button>
    <button class="btn btn-light btn-sm mb-2" (click)="zoomOut()" [disabled]="scale <= minScale" title="Diminuir Zoom">
      <i class="bi bi-dash-lg"></i>
    </button>
    <button class="btn btn-light btn-sm mb-2" (click)="resetZoom()" title="Resetar Visualização">
      <i class="bi bi-arrows-angle-contract"></i>
    </button>
    <div class="zoom-indicator">
      {{ (scale * 100) | number:'1.0-0' }}%
    </div>
  </div>

  <!-- Download Button -->
  <div class="download-control">
    <button class="btn btn-primary btn-sm" (click)="downloadMap()" title="Baixar Mapa">
      <i class="bi bi-download"></i>
    </button>
  </div>

  <!-- Info Panel -->
  <div class="info-panel" [class.show]="showInfo" *ngIf="loteamentoInfo">
    <div class="info-header">
      <h5 class="mb-0">Informações do Loteamento</h5>
      <button class="btn-close" (click)="toggleInfo()"></button>
    </div>
    <div class="info-body">
      <div class="info-item">
        <span class="label">Nome:</span>
        <span class="value">{{ loteamentoInfo.loteamento?.nome }}</span>
      </div>
      <div class="info-item">
        <span class="label">Localização:</span>
        <span class="value">{{ loteamentoInfo.loteamento?.cidade }} - {{ loteamentoInfo.loteamento?.estado }}</span>
      </div>
      <hr>
      <div class="row g-2">
        <div class="col-6">
          <div class="stat-card text-success">
            <i class="bi bi-check-circle"></i>
            <div class="value">{{ loteamentoInfo.total_lotes_disponiveis || 0 }}</div>
            <div class="label">Disponíveis</div>
          </div>
        </div>
        <div class="col-6">
          <div class="stat-card text-primary">
            <i class="bi bi-cash-coin"></i>
            <div class="value">{{ loteamentoInfo.total_lotes_vendidos || 0 }}</div>
            <div class="label">Vendidos</div>
          </div>
        </div>
        <div class="col-6">
          <div class="stat-card text-warning">
            <i class="bi bi-lock"></i>
            <div class="value">{{ loteamentoInfo.total_lotes_reservados || 0 }}</div>
            <div class="label">Reservados</div>
          </div>
        </div>
        <div class="col-6">
          <div class="stat-card text-danger">
            <i class="bi bi-x-circle"></i>
            <div class="value">{{ loteamentoInfo.total_lotes_bloqueados || 0 }}</div>
            <div class="label">Bloqueados</div>
          </div>
        </div>
      </div>
      <hr>
      <div class="info-item">
        <span class="label">Total de Lotes:</span>
        <span class="value fw-bold">{{ loteamentoInfo.total_lotes_cadastrados || 0 }}</span>
      </div>
    </div>
  </div>
</div>
